#include <AccelStepper.h>
#include "Adafruit_LiquidCrystal.h"

// =======================================================
//                     PIN ASSIGNMENTS
// =======================================================

// NEW PIN MAPPING (2-pin motors)
const int motorL1 = 2;   // Left shuffle forward
const int motorL2 = 3;   // Left shuffle backward
const int motorR1 = 4;   // Right shuffle forward
const int motorR2 = 5;   // Right shuffle backward
const int motorD1 = 8;   // Deal forward
const int motorD2 = 9;   // Deal backward
const int motorS1 = 6;   // Shooter forward
const int motorS2 = 7;   // Shooter backward

// Stepper 28BYJ-48 + ULN2003
#define IN1 10
#define IN2 11
#define IN3 12
#define IN4 13

// BUTTONS (Mega 2560)
const int butPlayUp   = 53;
const int butPlayDown = 52;
const int butCardUp   = 49;
const int butCardDown = 48;
const int butStart    = 51;

// Photoresistors
const int phoRight = A0;
const int phoLeft  = A1;

// Random seed pin
const int randPin = A3;

// =======================================================
//                     CONSTANTS
// =======================================================

const unsigned long shuffleRunTime   = 300;
const unsigned long dealForwardTime  = 45;
const unsigned long dealBackwardTime = 150;

const int sensorThreshold = 1;

int numPlayers = 4;
int numCards   = 52;

// LCD
Adafruit_LiquidCrystal lcd(0);

// =======================================================
//                     STEPPER
// =======================================================

AccelStepper stepper(AccelStepper::FULL4WIRE, IN1, IN3, IN2, IN4);

const float stepsPerRev = 2048.0;
const float stepsPerDegree = stepsPerRev / 360.0;

float currentAngle = 0.0;
int stepperSpeed = 1000;

// =======================================================
//                   MOTOR HELPERS
// =======================================================

void motorForward(int pin1, int pin2, unsigned long t) {
  Serial.print("Motor forward: ");
  Serial.print(pin1); Serial.print(" / "); Serial.print(pin2);
  Serial.print(" for "); Serial.print(t); Serial.println("ms");

  digitalWrite(pin1, HIGH);
  digitalWrite(pin2, LOW);
  delay(t);
  digitalWrite(pin1, LOW);
  digitalWrite(pin2, LOW);
}

void motorBackward(int pin1, int pin2, unsigned long t) {
  Serial.print("Motor backward: ");
  Serial.print(pin1); Serial.print(" / "); Serial.print(pin2);
  Serial.print(" for "); Serial.print(t); Serial.println("ms");

  digitalWrite(pin1, LOW);
  digitalWrite(pin2, HIGH);
  delay(t);
  digitalWrite(pin1, LOW);
  digitalWrite(pin2, LOW);
}

void allOff() {
  digitalWrite(motorL1, LOW);
  digitalWrite(motorL2, LOW);
  digitalWrite(motorR1, LOW);
  digitalWrite(motorR2, LOW);
  digitalWrite(motorD1, LOW);
  digitalWrite(motorD2, LOW);
  digitalWrite(motorS1, LOW);
  digitalWrite(motorS2, LOW);
}

// Shuffle
void runShuffleLeft()  { Serial.println("Shuffle LEFT");  motorForward(motorL1, motorL2, shuffleRunTime); }
void runShuffleRight() { Serial.println("Shuffle RIGHT"); motorForward(motorR1, motorR2, shuffleRunTime); }

// Deal
void runDealForward()  { Serial.println("Deal FORWARD"); motorForward(motorD1, motorD2, dealForwardTime); }
void runDealBackward() { Serial.println("Deal BACKWARD"); motorBackward(motorD1, motorD2, dealBackwardTime); }

// Shooter
void shooterOn()  { Serial.println("Shooter ON");  digitalWrite(motorS1, HIGH); digitalWrite(motorS2, LOW); }
void shooterOff() { Serial.println("Shooter OFF"); digitalWrite(motorS1, LOW);  digitalWrite(motorS2, LOW); }

// =======================================================
//                        SENSORS
// =======================================================

bool leftHasCards() {
  int v = analogRead(phoLeft);
  Serial.print("Left sensor = "); Serial.println(v);
  return v < sensorThreshold;
}

bool rightHasCards() {
  int v = analogRead(phoRight);
  Serial.print("Right sensor = "); Serial.println(v);
  return v < sensorThreshold;
}

// =======================================================
//                     LCD ANIMATIONS
// =======================================================

void lcdShufflingAnimation() {
  lcd.clear();
  lcd.print("Shuffling...");
  Serial.println("LCD: Shuffling animation");

  for (int i = 0; i < 3; i++) {
    lcd.setCursor(0, 1); lcd.print(".   "); delay(250);
    lcd.setCursor(0, 1); lcd.print("..  "); delay(250);
    lcd.setCursor(0, 1); lcd.print("..."); delay(250);
  }
}

void lcdDealingAnimation() {
  lcd.clear();
  lcd.print("Dealing cards");
  Serial.println("LCD: Dealing animation");

  for (int i = 0; i < 5; i++) {
    lcd.setCursor(0, 1); lcd.print(">");   delay(150);
    lcd.setCursor(0, 1); lcd.print(">>");  delay(150);
    lcd.setCursor(0, 1); lcd.print(">>>"); delay(150);
    lcd.setCursor(0, 1); lcd.print("    "); delay(150);
  }
}

void updateLCD() {
  Serial.print("LCD Update: Players=");
  Serial.print(numPlayers);
  Serial.print(" Cards=");
  Serial.println(numCards);

  lcd.clear();
  lcd.setCursor(0,0); lcd.print("Players: "); lcd.print(numPlayers);
  lcd.setCursor(0,1); lcd.print("Cards:   "); lcd.print(numCards);
}

// =======================================================
//                     STEPPER CONTROL
// =======================================================

void setSpeed(int spd) {
  Serial.print("Stepper speed set to: "); Serial.println(spd);
  stepperSpeed = constrain(spd, 200, 1800);
  stepper.setMaxSpeed(stepperSpeed);
}

void rotateDegrees(float degrees) {
  Serial.print("Rotating "); Serial.print(degrees); Serial.println(" degrees");

  float diff = degrees;
  if (diff > 180) diff -= 360;
  if (diff < -180) diff += 360;

  long steps = diff * stepsPerDegree;
  stepper.move(steps);
  currentAngle += diff;

  if (currentAngle >= 360) currentAngle -= 360;
  if (currentAngle < 0)    currentAngle += 360;
}

// =======================================================
//                   SERIAL TEST MODE
// =======================================================

void runTestMode() {
  lcd.clear();
  lcd.setCursor(0,0); lcd.print("TEST MODE");
  lcd.setCursor(0,1); lcd.print("Serial Control");

  Serial.println("\n===== TEST MODE =====");
  Serial.println("Commands:");
  Serial.println("  L1 = Shuffle LEFT");
  Serial.println("  R1 = Shuffle RIGHT");
  Serial.println("  DF = Deal FORWARD");
  Serial.println("  DB = Deal BACKWARD");
  Serial.println("  S1 = Shooter ON");
  Serial.println("  S0 = Shooter OFF");
  Serial.println("  CW / CCW = Stepper rotation");
  Serial.println("  SPD### = Stepper Speed");
  Serial.println("  READ = Sensor Values");
  Serial.println("=======================");

  while (true) {
    stepper.run();

    if (Serial.available()) {
      String cmd = Serial.readStringUntil('\n');
      cmd.trim();

      Serial.print("CMD RECEIVED: ");
      Serial.println(cmd);

      if (cmd == "L1") runShuffleLeft();
      if (cmd == "R1") runShuffleRight();
      if (cmd == "DF") runDealForward();
      if (cmd == "DB") runDealBackward();
      if (cmd == "S1") shooterOn();
      if (cmd == "S0") shooterOff();
      if (cmd == "CW")  rotateDegrees(360);
      if (cmd == "CCW") rotateDegrees(-360);

      if (cmd.startsWith("SPD")) {
        int sp = cmd.substring(3).toInt();
        setSpeed(sp);
      }

      if (cmd == "READ") {
        Serial.print("Left Sensor  = ");  Serial.println(analogRead(phoLeft));
        Serial.print("Right Sensor = "); Serial.println(analogRead(phoRight));
      }
    }
  }
}

// =======================================================
//                        SETUP
// =======================================================

void setup() {
  Serial.begin(9600);
  delay(200);

  Serial.println("=== Arduino Startup ===");
  Serial.println("Initializing hardware...");

  randomSeed(analogRead(randPin));

  // Motor pins
  pinMode(motorL1, OUTPUT); pinMode(motorL2, OUTPUT);
  pinMode(motorR1, OUTPUT); pinMode(motorR2, OUTPUT);
  pinMode(motorD1, OUTPUT); pinMode(motorD2, OUTPUT);
  pinMode(motorS1, OUTPUT); pinMode(motorS2, OUTPUT);
  Serial.println("Motor pins initialized.");

  // Buttons
  pinMode(butPlayUp,   INPUT_PULLUP);
  pinMode(butPlayDown, INPUT_PULLUP);
  pinMode(butCardUp,   INPUT_PULLUP);
  pinMode(butCardDown, INPUT_PULLUP);
  pinMode(butStart,    INPUT_PULLUP);
  Serial.println("Button pins ready.");

  // LCD
  lcd.begin(16,2);
  Serial.println("LCD initialized.");

  // Stepper
  stepper.setMaxSpeed(stepperSpeed);
  stepper.setAcceleration(800);
  Serial.println("Stepper initialized.");

  Serial.println("All motors OFF.");

  updateLCD();
  Serial.println("Startup complete.\n");
}

// =======================================================
//                        LOOP
// =======================================================

void loop() {
  // Serial test mode trigger
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd == "TEST") runTestMode();
  }

  // Buttons
  if (!digitalRead(butPlayUp)) {
    Serial.println("Button: Play Up");
    numPlayers++; updateLCD(); delay(200);
  }

  if (!digitalRead(butPlayDown)) {
    Serial.println("Button: Play Down");
    if (numPlayers > 1) numPlayers--; updateLCD(); delay(200);
  }

  if (!digitalRead(butCardUp)) {
    Serial.println("Button: Card Up");
    numCards++; updateLCD(); delay(200);
  }

  if (!digitalRead(butCardDown)) {
    Serial.println("Button: Card Down");
    if (numCards > 1) numCards--; updateLCD(); delay(200);
  }

  // Start button
  if (!digitalRead(butStart)) {
    Serial.println("=== START PRESSED ===");

    lcdShufflingAnimation();

    bool left  = leftHasCards();
    bool right = rightHasCards();

    // SHUFFLING
    while (left || right) {
      if (!digitalRead(butStart)) {  
        Serial.println("Start pressed again â€” skipping remaining shuffle.");
        break;  
      }
      if (left && right) {
        Serial.println("Random shuffle choice");
        (random(0,2) == 0) ? runShuffleLeft() : runShuffleRight();
      }
      else if (left)  runShuffleLeft();
      else if (right) runShuffleRight();

      delay(55);
      left  = leftHasCards();
      right = rightHasCards();
    }

    // DEALING
    lcdDealingAnimation();
    float angle = 360.0 / numPlayers;
    shooterOn();
    int remaining = numCards;

    while (remaining > 0) {
      Serial.print("Dealing card "); Serial.println(remaining);
      runDealForward();
      rotateDegrees(angle);
      remaining--;
    }

    shooterOff();

    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("  Finished!");

    Serial.println("=== DEALING FINISHED ===");

    delay(1500);
    updateLCD();
  }

  stepper.run();
}
