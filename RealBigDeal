#include "Adafruit_LiquidCrystal.h"

/* =======================
   PIN ASSIGNMENTS (UNO)
   ======================= */
const int motorL  = 2;
const int motorR  = 3;
const int motorD1 = 4;
const int motorD2 = 5;
const int motorS  = 6;

const int STEP_PIN   = 7;
const int DIR_PIN    = 8;
const int ENABLE_PIN = 9;

const int MS1_PIN = 11;
const int MS2_PIN = 12;
const int MS3_PIN = 13;

const int butCardUp   = 10;
const int butCardDown = A0;
const int butPlayUp   = A1;
const int butPlayDown = A2;
const int butStart    = A3;

/* =======================
   CONSTANTS
   ======================= */
const unsigned long shuffleRunTime = 300;
const unsigned long shuffleDelay   = 1000;

const unsigned long dealForwardTime  = 200;
const unsigned long dealBackwardTime = 150;
const unsigned long dealDelay        = 35;

const int STEPS_PER_REV = 200;
const int MICROSTEPPING = 16;
const int STEP_DELAY_US = 90;

int numPlayers = 4;
int numCards   = 52;

Adafruit_LiquidCrystal lcd(0);

/* =======================
   MOTOR HELPERS
   ======================= */
void motorPulse(int pin, unsigned long t) {
  digitalWrite(pin, HIGH);
  delay(t);
  digitalWrite(pin, LOW);
}

void motorForward(int pin1, int pin2, unsigned long t) {
  digitalWrite(pin1, HIGH);
  digitalWrite(pin2, LOW);
  delay(t);
  digitalWrite(pin1, LOW);
  digitalWrite(pin2, LOW);
}

void motorBackward(int pin1, int pin2, unsigned long t) {
  digitalWrite(pin1, LOW);
  digitalWrite(pin2, HIGH);
  delay(t);
  digitalWrite(pin1, LOW);
  digitalWrite(pin2, LOW);
}

void allOff() {
  digitalWrite(motorL, LOW);
  digitalWrite(motorR, LOW);
  digitalWrite(motorD1, LOW);
  digitalWrite(motorD2, LOW);
  digitalWrite(motorS, LOW);
}

/* =======================
   ACTIONS
   ======================= */
void runShuffleLeft()  { motorPulse(motorL, shuffleRunTime); }
void runShuffleRight() { motorPulse(motorR, shuffleRunTime); }

void runAlternate() {
  while (digitalRead(butStart)) {
    runShuffleLeft();
    delay(shuffleDelay);
    runShuffleRight();
    delay(shuffleDelay);
  }
}

void runDealForward()  { motorForward(motorD1, motorD2, dealForwardTime); }
void runDealBackward() { motorBackward(motorD1, motorD2, dealBackwardTime); }

void shooterOn()  { digitalWrite(motorS, HIGH); }
void shooterOff() { digitalWrite(motorS, LOW); }

/* =======================
   STEPPER
   ======================= */
long degreesToSteps(float degrees) {
  float stepsPerDegree = (STEPS_PER_REV * MICROSTEPPING) / 360.0;
  return (long)(degrees * stepsPerDegree);
}

void rotateDegrees(float degrees) {
  long steps = abs(degreesToSteps(degrees));
  digitalWrite(DIR_PIN, degrees > 0);
  digitalWrite(ENABLE_PIN, LOW);

  for (long i = 0; i < steps; i++) {
    digitalWrite(STEP_PIN, HIGH);
    delayMicroseconds(STEP_DELAY_US);
    digitalWrite(STEP_PIN, LOW);
    delayMicroseconds(STEP_DELAY_US);
  }
  digitalWrite(ENABLE_PIN, HIGH);
}

/* =======================
   LCD
   ======================= */
void updateLCD() {
  lcd.clear();
  lcd.setCursor(0,0); lcd.print("Players: "); lcd.print(numPlayers);
  lcd.setCursor(0,1); lcd.print("Cards: ");   lcd.print(numCards);
}

/* =======================
   TEST MODE
   ======================= */
void runTestMode() {
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("TEST MODE");
  lcd.setCursor(0,1);
  lcd.print("Ready");

  Serial.println("\n=== TEST MODE ===");

  while (true) {

    /* ===== EXIT ===== */
    if (!digitalRead(butStart)) {
      lcd.clear();
      lcd.print("Exit Test Mode");
      Serial.println("Exit Test Mode");
      delay(500);
      updateLCD();
      return;
    }

    /* ===== SHUFFLE TEST ===== */
    if (!digitalRead(butPlayUp)) {
      Serial.println("Shuffle Left");
      lcd.clear();
      lcd.print("Shuffle Left");
      runShuffleLeft();
      delay(shuffleDelay);

      Serial.println("Shuffle Right");
      lcd.clear();
      lcd.print("Shuffle Right");
      runShuffleRight();
      delay(shuffleDelay);

      lcd.clear();
      lcd.print("TEST MODE");
      lcd.setCursor(0,1);
      lcd.print("Ready");
    }

    /* ===== SHOOTER + DEAL ===== */
    if (!digitalRead(butPlayDown)) {
      Serial.println("Shooter ON");
      lcd.clear();
      lcd.print("Shooter ON");
      shooterOn();
      delay(1000);

      Serial.println("Shooter OFF");
      lcd.clear();
      lcd.print("Shooter OFF");
      shooterOff();
      delay(300);

      Serial.println("Deal Forward");
      lcd.clear();
      lcd.print("Deal Forward");
      runDealForward();
      delay(300);

      lcd.clear();
      lcd.print("TEST MODE");
      lcd.setCursor(0,1);
      lcd.print("Ready");
    }

    /* ===== STEPPER ===== */
    if (!digitalRead(butCardUp)) {
      Serial.println("Rotate 180");
      lcd.clear();
      lcd.print("Rotate 180");
      rotateDegrees(180);
      delay(300);

      lcd.clear();
      lcd.print("TEST MODE");
      lcd.setCursor(0,1);
      lcd.print("Ready");
    }

    /* ===== STATUS ===== */
    if (!digitalRead(butCardDown)) {
      Serial.println("System OK");
      lcd.clear();
      lcd.print("System OK");
      lcd.setCursor(0,1);
      lcd.print("No sensors");
      delay(500);

      lcd.clear();
      lcd.print("TEST MODE");
      lcd.setCursor(0,1);
      lcd.print("Ready");
    }
  }
}

/* =======================
   SETUP
   ======================= */
void setup() {
  Serial.begin(9600);
  Serial.println("Setting Up");
  pinMode(motorL, OUTPUT);
  pinMode(motorR, OUTPUT);
  pinMode(motorD1, OUTPUT);
  pinMode(motorD2, OUTPUT);
  pinMode(motorS, OUTPUT);

  pinMode(STEP_PIN, OUTPUT);
  pinMode(DIR_PIN, OUTPUT);
  pinMode(ENABLE_PIN, OUTPUT);
  digitalWrite(ENABLE_PIN, HIGH);

  pinMode(MS1_PIN, OUTPUT);
  pinMode(MS2_PIN, OUTPUT);
  pinMode(MS3_PIN, OUTPUT);

  digitalWrite(MS1_PIN, HIGH);
  digitalWrite(MS2_PIN, HIGH);
  digitalWrite(MS3_PIN, HIGH);

  pinMode(butPlayUp, INPUT_PULLUP);
  pinMode(butPlayDown, INPUT_PULLUP);
  pinMode(butCardUp, INPUT_PULLUP);
  pinMode(butCardDown, INPUT_PULLUP);
  pinMode(butStart, INPUT_PULLUP);

  lcd.begin(16,2);
  allOff();
  updateLCD();
}

/* =======================
   LOOP
   ======================= */
void loop() {
  static unsigned long testHoldStart = 0;

  if (!digitalRead(butPlayUp) && !digitalRead(butCardDown)) {
    if (testHoldStart == 0) testHoldStart = millis();
    if (millis() - testHoldStart >= 1000) {
      runTestMode();
      testHoldStart = 0;
    }
  } else {
    testHoldStart = 0;
  }

  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd == "TEST") runTestMode();
  }

  if (!digitalRead(butPlayUp))   { numPlayers++; updateLCD(); delay(200); }
  if (!digitalRead(butPlayDown)) { if (numPlayers > 1) numPlayers--; updateLCD(); delay(200); }

  if (!digitalRead(butCardUp))   { numCards++; updateLCD(); delay(200); }
  if (!digitalRead(butCardDown)) { if (numCards > 1) numCards--; updateLCD(); delay(200); }

  if (!digitalRead(butStart)) {
    runAlternate();

    float angle = 360.0 / numPlayers;
    shooterOn();

    for (int i = 0; i < numCards; i++) {
      runDealForward();
      delay(dealDelay);
      runDealBackward();
      rotateDegrees(angle);
    }

    shooterOff();
    lcd.clear();
    lcd.print("Finished!");
    delay(1500);
    updateLCD();
  }
}
